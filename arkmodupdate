#!/bin/bash

mapfile -t instances < <( /usr/local/bin/arkmanager list-instances --brief )
needUpdate=()

for inst in "${instances[@]}"; do
  /usr/local/bin/arkmanager checkmodupdate "@$inst" --revstatus
  updateNeeded=$?
  [[ "$updateNeeded" -ne 0 ]] && needUpdate+=( "@$inst" )
done

for upd in "${needUpdate[@]}" ; do
  /usr/local/bin/arkmanager stop "$upd" --warn --warnreason="Mod update"
  /usr/local/bin/arkmanager update "$upd" --update-mods --backup
  /usr/local/bin/arkmanager start "$upd"
done
