#!/bin/bash

/usr/local/bin/arkmanager checkmodupdate --revstatus
updateNeeded=$?

case $updateNeeded in
  0 )
    exit 0
    ;;

  4 )
    exit 1
    ;;

  * )
    echo "Starting mod updates :: $updateNeeded"
    ;;
esac

/usr/local/bin/arkmanager update --update-mods --warn

mapfile -t instances < <( /usr/local/bin/arkmanager list-instances --brief )

for instName in "${instances[@]}" ; do
    echo "Updating mods for $instName"

    cfg="/ark/config/instances/${instName}.cfg"
    upd="@${instName}"
    shallowPath="$(/usr/local/bin/check-shallow-ark "$cfg")"
    
    # Not shallow
    if [[ -z "$shallowPath" ]]; then
        # non-shallow instances have to be updated separately
        /usr/local/bin/arkmanager update "$upd" --update-mods --warn
    else
        # Finally, go back to hardlinks
        /usr/local/bin/arkmanager stop "$upd" --warn --warnreason="Mod Update"
        /usr/local/bin/ark-gen-shallow "$shallowPath"
        /usr/local/bin/ark-set-shallow-save "$shallowPath" "$instName"
        /usr/local/bin/arkmanager start "$upd" --noautoupdate
    fi
done
