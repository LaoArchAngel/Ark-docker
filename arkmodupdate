#!/bin/bash

mapfile -t instances < <( /usr/local/bin/arkmanager list-instances --brief )
needUpdate=()

for inst in "${instances[@]}"; do
  /usr/local/bin/arkmanager checkmodupdate "@$inst" --revstatus
  updateNeeded=$?

  if [[ "$updateNeeded" -ne 0 ]]; then
    needUpdate+=( "$inst" )
    /usr/local/bin/arkmanager stop "@$inst" --warn --warnreason="Mod update"
  fi
done

for instName in "${needUpdate[@]}" ; do
    echo "Updating mods for "$instName""

    cfg="/ark/config/instances/${instName}.cfg"
    upd="@${instName}"
    shallowPath="$(/usr/local/bin/check-shallow-ark "$cfg")"
    
    # Not shallow
    if [[ -z "$shallowPath" ]]; then
        # non-shallow instances have to be updated separately
        /usr/local/bin/arkmanager update "$upd" --update-mods
        /usr/local/bin/arkmanager start "$upd" --noautoupdate
    else
        # First make a link to the main mod folder
        modPath="${shallowPath}/ShooterGame/Content/Mods"
        rm -Rf "$modPath"
        ln -s /ark/server/install/ShooterGame/Content/Mods "$modPath"

        # Now update the mods
        /usr/local/bin/arkmanager update "$upd" --update-mods

        # Finally, go back to hardlinks
        /usr/local/bin/ark-gen-shallow "$shallowPath"
        /usr/local/bin/ark-set-shallow-save "$shallowPath" "$instName"
        /usr/local/bin/arkmanager start "$upd" --noautoupdate
    fi
done

/usr/local/bin/arkmanager start @all --noautoupdate
